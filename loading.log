Script started on 2023-08-02 12:13:42+07:00 [TERM="xterm" TTY="/dev/pts/0" COLUMNS="173" LINES="40"]
]0;garik@garik-VirtualBox: ~/DZ/DZ23garik@garik-VirtualBox:~/DZ/DZ23$ vagrant up
[0mBringing machine 'pam' up with 'virtualbox' provider...[0m
[1m==> pam: Importing base box 'centos/8'...[0m
[0m[K[0m[0mProgress: 20%[0m[0m[K[0m[0mProgress: 40%[0m[0m[K[0m[0mProgress: 50%[0m[0m[K[0m[0mProgress: 70%[0m[0m[K[0m[0mProgress: 90%[0m[0m[K[0m[1m==> pam: Matching MAC address for NAT networking...[0m
[1m==> pam: Setting the name of the VM: DZ23_pam_1690953273090_20658[0m
[1m==> pam: Clearing any previously set network interfaces...[0m
[1m==> pam: Preparing network interfaces based on configuration...[0m
[0m    pam: Adapter 1: nat[0m
[0m    pam: Adapter 2: hostonly[0m
[1m==> pam: Forwarding ports...[0m
[0m    pam: 22 (guest) => 2222 (host) (adapter 1)[0m
[1m==> pam: Running 'pre-boot' VM customizations...[0m
[1m==> pam: Booting VM...[0m
[1m==> pam: Waiting for machine to boot. This may take a few minutes...[0m
[0m    pam: SSH address: 127.0.0.1:2222[0m
[0m    pam: SSH username: vagrant[0m
[0m    pam: SSH auth method: private key[0m
[0m    pam: 
    pam: Vagrant insecure key detected. Vagrant will automatically replace
    pam: this with a newly generated keypair for better security.[0m
[0m    pam: 
    pam: Inserting generated public key within guest...[0m
[0m    pam: Removing insecure key from the guest if it's present...[0m
[0m    pam: Key inserted! Disconnecting and reconnecting using new SSH key...[0m
[1m==> pam: Machine booted and ready![0m
[1m==> pam: Checking for guest additions in VM...[0m
[0m    pam: No guest additions were detected on the base box for this VM! Guest
    pam: additions are required for forwarded ports, shared folders, host only
    pam: networking, and more. If SSH fails on this machine, please install
    pam: the guest additions and repackage the box to continue.
    pam: 
    pam: This is not an error message; everything may continue to work properly,
    pam: in which case you may ignore this message.[0m
[1m==> pam: Setting hostname...[0m
[1m==> pam: Configuring and enabling network interfaces...[0m
[1m==> pam: Running provisioner: shell...[0m
[0m    pam: Running: inline script[0m
]0;garik@garik-VirtualBox: ~/DZ/DZ23garik@garik-VirtualBox:~/DZ/DZ23$ vagrant ssh
]0;vagrant@pam:~[vagrant@pam ~]$ sudo -i
]0;root@pam:~[root@pam ~]# sudo useradd otusadm && sudo useradd otus
]0;root@pam:~[root@pam ~]# echo "Otus2022!" | sudo passwd --stdin otusadm && echo "Otus2022!" | sudo passwd --stdin otus
Changing password for user otusadm.
passwd: all authentication tokens updated successfully.
Changing password for user otus.
passwd: all authentication tokens updated successfully.
]0;root@pam:~[root@pam ~]# sudo groupadd -f admin
]0;root@pam:~[root@pam ~]# usermod otusadm -a -G admin && usermod root -a -G admin && usermod vagrant -a -G admin
]0;root@pam:~[root@pam ~]# ssh otus@192.168.56.10
The authenticity of host '192.168.56.10 (192.168.56.10)' can't be established.
ECDSA key fingerprint is SHA256:scSI6cCRy5BkOHH0/mZXbeI/LzGVJh0HVRvqsjop324.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yea s
Warning: Permanently added '192.168.56.10' (ECDSA) to the list of known hosts.
otus@192.168.56.10's password: 
]0;otus@pam:~[otus@pam ~]$ ewzx[K[K[K[Kexit
logout
Connection to 192.168.56.10 closed.
]0;root@pam:~[root@pam ~]# ssh otusadm@192.168.56.10
otusadm@192.168.56.10's password: 
]0;otusadm@pam:~[otusadm@pam ~]$ exit
logout
Connection to 192.168.56.10 closed.
]0;root@pam:~[root@pam ~]# cat /etc/group | grep admin
print[01;31m[Kadmin[m[K:x:994:
[01;31m[Kadmin[m[K:x:1003:otusadm,root,vagrant
]0;root@pam:~[root@pam ~]# cat > /usr/local/bin/login.sh
#!/bin/bash
#Первое условие: если день недели суббота или воскресенье
if [ $(date +%a) = "Sat" ] || [ $(date +%a) = "Sun" ]; then
 #Второе условие: входит ли пользователь в группу admin
 if getent group admin | grep -qw "$PAM_USER"; then
        #Если пользователь входит в группу admin, то он может подключиться
        exit 0
      else
        #Иначе ошибка (не сможет подключиться)
        exit 1
    fi
  #Если день не выходной, то подключиться может любой пользователь
  else
    exit 0
fi
]0;root@pam:~[root@pam ~]# chmod +x /usr/local/bin/login.sh
]0;root@pam:~[root@pam ~]# cat /etc/pam.d/sshd
#%PAM-1.0
auth       substack     password-auth
auth       include      postlogin
account    required     pam_sepermit.so
account    required     pam_nologin.so
account    include      password-auth
password   include      password-auth
# pam_selinux.so close should be the first session rule
session    required     pam_selinux.so close
session    required     pam_loginuid.so
# pam_selinux.so open should only be followed by sessions to be executed in the user context
session    required     pam_selinux.so open env_params
session    required     pam_namespace.so
session    optional     pam_keyinit.so force revoke
session    optional     pam_motd.so
session    include      password-auth
session    include      postlogin
]0;root@pam:~[root@pam ~]# cat > /etc/pam.d/sshd
#%PAM-1.0
auth       required		pam_sepermit.so
auth       substack     password-auth
auth       include      postlogin
#account    required     dad
#auth required pam-script.so /usr/local/bin/login.sh
auth       optional		pam_reauthorize.so prepare
account    required     pam_exec.so /usr/local/bin/login.sh
account    required     pam_nologin.so
account    include      password-auth
password   include      password-auth
# pam_selinux.so close should be the first session rule
session    required     pam_selinux.so close
session    required     pam_loginuid.so
# pam_selinux.so open should only be followed by sessions to be executed in the user context
session    required     pam_selinux.so open env_params
session    required     pam_namespace.so
session    optional     pam_keyinit.so force revoke
session    include      password-auth
session    include      postlogin
session    optional		pam_reauthorize.so prepare
]0;root@pam:~[root@pam ~]# sudo date 082712302022.00
Sat Aug 27 12:30:00 UTC 2022
]0;root@pam:~[root@pam ~]# sudo date 082712302022.00
Sat Aug 27 12:30:00 UTC 2022
]0;root@pam:~[root@pam ~]# ssh otus@192.168.56.10
otus@192.168.56.10's password: 
/usr/local/bin/login.sh failed: exit code 1
Connection closed by 192.168.56.10 port 22
]0;root@pam:~[root@pam ~]# ssh otus@192.168.56.10a@192.168.56.10d@192.168.56.10m@192.168.56.10
otusadm@192.168.56.10's password: 
Last login: Wed Aug  2 05:21:14 2023 from 192.168.56.10
]0;otusadm@pam:~[otusadm@pam ~]$ exit
logout
Connection to 192.168.56.10 closed.
]0;root@pam:~[root@pam ~]# date 082512302022.00
Thu Aug 25 12:30:00 UTC 2022
]0;root@pam:~[root@pam ~]# date 082512302022.00[C[C[C[C[C[C[C[C[C[C[C[C[C[Cssh otusadm@192.168.56.10
otusadm@192.168.56.10's password: 
Last login: Sat Aug 27 12:30:33 2022 from 192.168.56.10
]0;otusadm@pam:~[otusadm@pam ~]$ exit
logout
Connection to 192.168.56.10 closed.
]0;root@pam:~[root@pam ~]# ssh otusadm@192.168.56.10[1Pdm@192.168.56.10[1Pm@192.168.56.10[1P@192.168.56.10
otus@192.168.56.10's password: 
Last login: Wed Aug  2 05:20:49 2023 from 192.168.56.10
]0;otus@pam:~[otus@pam ~]$ ls -la
total 16
drwx------. 2 otus otus  83 Aug  2  2023 [0m[01;34m.[0m
drwxr-xr-x. 5 root root  48 Aug  2  2023 [01;34m..[0m
-rw-------. 1 otus otus   5 Aug  2  2023 .bash_history
-rw-r--r--. 1 otus otus  18 Jul 21  2020 .bash_logout
-rw-r--r--. 1 otus otus 141 Jul 21  2020 .bash_profile
-rw-r--r--. 1 otus otus 376 Jul 21  2020 .bashrc
]0;otus@pam:~[otus@pam ~]$ exit
logout
Connection to 192.168.56.10 closed.
]0;root@pam:~[root@pam ~]# exit
logout
]0;vagrant@pam:~[vagrant@pam ~]$ exit
logout
Connection to 127.0.0.1 closed.
]0;garik@garik-VirtualBox: ~/DZ/DZ23garik@garik-VirtualBox:~/DZ/DZ23$ xit[K[K[Kexit
exit

Script done on 2023-08-02 12:25:11+07:00 [COMMAND_EXIT_CODE="0"]
